name: Save Submission on Issue Close

on:
  issues:
    types: [closed]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to process'
        required: true
        type: number

permissions:
  contents: write
  issues: write

jobs:
  save-submission:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract and save submission
        id: extract
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const issue = context.payload.issue;

            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number
            });

            let submissionContent = null;
            let submitter = issue.user.login;

            for (const comment of comments.data.reverse()) {
              if (comment.body.toLowerCase().includes('submission') ||
                  comment.body.toLowerCase().includes('deliverable') ||
                  comment.body.length > 200) {
                submissionContent = comment.body;
                submitter = comment.user.login;
                break;
              }
            }

            if (!submissionContent) {
              submissionContent = issue.body || 'No submission content found.';
            }

            const slug = issue.title
              .toLowerCase()
              .replace(/[^a-z0-9]+/g, '-')
              .replace(/^-|-$/g, '')
              .substring(0, 50);

            const date = new Date().toISOString().split('T')[0];
            const labels = issue.labels.map(l => l.name).join(', ') || 'None';

            const fileContent = `# ${issue.title}\n\n` +
              `**Issue:** #${issue.number}\n` +
              `**Submitted by:** @${submitter}\n` +
              `**Closed on:** ${date}\n` +
              `**Labels:** ${labels}\n\n` +
              `---\n\n` +
              `${submissionContent}\n\n` +
              `---\n\n` +
              `_Auto-generated from [Issue #${issue.number}](${issue.html_url})_\n`;

            const submissionsDir = 'submissions';
            if (!fs.existsSync(submissionsDir)) {
              fs.mkdirSync(submissionsDir);
            }

            const filename = `${submissionsDir}/issue-${issue.number}-${slug}.md`;
            fs.writeFileSync(filename, fileContent);

            const contributorsFile = 'CONTRIBUTORS.md';
            let contributors = {};

            if (fs.existsSync(contributorsFile)) {
              const content = fs.readFileSync(contributorsFile, 'utf8');
              const lines = content.split('\n');
              for (const line of lines) {
                const match = line.match(/@(\w+)\s*\|\s*(\d+)/);
                if (match) {
                  contributors[match[1]] = parseInt(match[2]);
                }
              }
            }

            contributors[submitter] = (contributors[submitter] || 0) + 1;

            const sortedContributors = Object.entries(contributors)
              .sort((a, b) => b[1] - a[1]);

            let newTable = '# Contributors\n\n' +
              'This file tracks all contributions to JustLab AI tasks.\n\n' +
              '| Contributor | Tasks Completed | Last Contribution |\n' +
              '|-------------|-----------------|-------------------|\n';

            for (const [user, count] of sortedContributors) {
              const lastDate = user === submitter ? date : '-';
              newTable += `| @${user} | ${count} | ${lastDate} |\n`;
            }

            fs.writeFileSync(contributorsFile, newTable);

            core.setOutput('filename', filename);
            core.setOutput('submitter', submitter);

      - name: Commit and push changes
        env:
          SUBMITTER: ${{ steps.extract.outputs.submitter }}
        run: |
          git config --local user.email "${SUBMITTER}@users.noreply.github.com"
          git config --local user.name "${SUBMITTER}"
          git add submissions/ CONTRIBUTORS.md
          git commit -m "Add submission for issue #${{ github.event.issue.number }}" || exit 0
          git push

      - name: Comment on issue
        uses: actions/github-script@v7
        env:
          SUBMITTER: ${{ steps.extract.outputs.submitter }}
        with:
          script: |
            const submitter = process.env.SUBMITTER;
            const issueNum = context.payload.issue.number;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNum,
              body: `Submission saved! Thank you for your contribution, @${submitter}!`
            });
